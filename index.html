<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“‹ O&T æ§åˆ¶å°</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 10px;
      background: #f4f4f4;
      font-size: 14px;
    }
    h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      font-size: 13px;
      min-width: 800px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    th {
      background: #eaeaea;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    input, select {
      width: 100%;
      padding: 4px;
      box-sizing: border-box;
      font-size: 13px;
      text-align: center;
    }
    button {
      padding: 6px 10px;
      font-size: 13px;
      margin: 4px 4px 4px 0;
      border: none;
      border-radius: 4px;
      background: #4caf50;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #388e3c;
    }
    .status-btn.pending {
      background: #ff9800;
    }
    .status-btn.completed {
      background: #4caf50;
    }
    .readonly {
      background: #f7f7f7;
      color: #888;
    }
    #lastUpdated {
      font-size: 12px;
      color: #555;
      margin-left: 10px;
    }
    .table-wrapper {
      overflow-x: auto;
      margin-top: 10px;
    }
    @media screen and (max-width: 768px) {
      body {
        font-size: 13px;
      }
      table {
        font-size: 12px;
        min-width: 600px;
      }
      button {
        font-size: 12px;
        padding: 5px 8px;
      }
      input, select {
        font-size: 12px;
      }
    }
    @media print {
      h2, #lastUpdated, button {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <h2>ğŸ“‹ O&T æ§åˆ¶å°</h2>
  <div>
    <button onclick="fetchData()">ğŸ” é‡æ–°è¼‰å…¥</button>
    <button onclick="exportCSV()">â¬‡ï¸ åŒ¯å‡º CSV</button>
    <button onclick="window.print()">ğŸ–¨ï¸ åˆ—å°å ±è¡¨</button>
    <span id="lastUpdated">ğŸ”„ è¼‰å…¥ä¸­...</span>
  </div>
  <div class="table-wrapper">
    <table id="dataTable">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbxbSjo8nWkCeR-dtyz2GDgswesTOnEzUUUHjiHSevXXqoGh0OVXB-HGBqeG4eBFe2Gz/exec";
    const table = document.getElementById("dataTable");
    let headers = [];
    let rowData = [];

    fetchData();
    setInterval(fetchData, 15000);

    function fetchData() {
      fetch(endpoint)
        .then(res => res.json())
        .then(data => {
          if (!data || !Array.isArray(data.headers) || !Array.isArray(data.rows)) {
            console.error("âš ï¸ ç„¡æ³•å–å¾—è³‡æ–™ï¼Œè«‹æª¢æŸ¥ API å›å‚³æ ¼å¼", data);
            alert("âš ï¸ ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¢ºèª Apps Script æ˜¯å¦æ­£ç¢ºå›å‚³ headers èˆ‡ rows");
            return;
          }
          headers = data.headers;
          rowData = data.rows.map(row => row.slice(0, headers.length));
          renderTable(rowData);
          document.getElementById("lastUpdated").textContent =
            "ğŸ”„ æœ€å¾Œæ›´æ–°ï¼š" + new Date().toLocaleString("zh-HK", { hour12: false });
        })
        .catch(err => {
          console.error("âŒ è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", err);
          alert("âŒ ç„¡æ³•é€£æ¥è³‡æ–™ä¾†æºï¼Œè«‹ç¨å¾Œå†è©¦");
        });
    }

    function renderTable(rows) {
      table.querySelector("thead").innerHTML = `
        <tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr>
        <tr>${headers.map((_, i) => `
          <th><input list="filter${i}" data-index="${i}" oninput="applyFilters()" placeholder="ğŸ” ç¯©é¸">
          <datalist id="filter${i}">${[...new Set(rowData.map(r => r[i]).filter(Boolean))].map(v => `<option>${v}</option>`).join("")}</datalist></th>
        `).join("")}</tr>`;

      table.querySelector("tbody").innerHTML = rows.map((row, i) => `
        <tr>${row.map((val, j) => {
          if (j === 0) return `<td><input value="${val||''}" class="readonly" readonly></td>`;
          if (headers[j].toLowerCase().includes("urgent")) {
            return `<td><select onchange="updateCell(${i},${j},this.value)">
              ${["Yes","No"].map(opt => `<option ${val===opt?"selected":""}>${opt}</option>`).join("")}</select></td>`;
          }
          if (headers[j].toLowerCase() === "status") {
            const isDone = (val||"").toLowerCase() === "completed";
            return `<td><button class="status-btn ${isDone?"completed":"pending"}" onclick="toggleStatus(${i})">${isDone?"âœ… Completed":"â³ Pending"}</button></td>`;
          }
          return `<td><input value="${val||''}" onchange="updateCell(${i},${j},this.value)"></td>`;
        }).join("")}</tr>`).join("");
    }

    function applyFilters() {
      const inputs = table.querySelectorAll("thead input");
      const filters = [...inputs].map(i => i.value.toLowerCase());
      const filtered = rowData.filter(r => filters.every((f, i) => !f || (r[i]||"").toString().toLowerCase().includes(f)));
      renderTable(filtered);
    }

    function updateCell(row, col, val) {
      fetch(`${endpoint}?action=update&row=${row}&col=${col}&val=${encodeURIComponent(val)}`);
    }

    function toggleStatus(row) {
      fetch(`${endpoint}?action=toggle&row=${row}`);
      setTimeout(fetchData, 500);
    }

    function exportCSV() {
      let csv = headers.join(",") + "\n" + rowData.map(row => row.map(v => `"${v||""}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "tasks.csv";
      link.click();
    }
  </script>
</body>
</html>
