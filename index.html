const SHEET_ID = "1h77IebbsEQmesShYKd49OTrqV6oTcXe60t-bEy5likM";
const SHEET_NAME = "OT Homework";

function doGet(e) {
  const action = e?.parameter?.action;
  if (action === "update") return doUpdate(e);
  if (action === "toggle") return doToggle(e);
  return ContentService.createTextOutput(JSON.stringify(getData()))
    .setMimeType(ContentService.MimeType.JSON);
}

function getData() {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    if (!sheet) {
      Logger.log("âŒ æ‰¾ä¸åˆ°å·¥ä½œè¡¨ï¼š" + SHEET_NAME);
      return { error: "æ‰¾ä¸åˆ°å·¥ä½œè¡¨ï¼š" + SHEET_NAME, headers: [], rows: [] };
    }

    const data = sheet.getDataRange().getValues();
    Logger.log("ğŸ“¦ æ•¸æ“šç¯„åœï¼š" + sheet.getDataRange().getA1Notation());
    Logger.log("ğŸ“¦ è³‡æ–™ç­†æ•¸ï¼š" + data.length + " è¡Œ");
    if (data.length > 1) {
      Logger.log("ğŸ“¦ ç¬¬äºŒè¡Œï¼š" + JSON.stringify(data[1]));
      Logger.log("ğŸ“¦ ç¬¬äºŒè¡Œé¡å‹ï¼š" + data[1].map(cell => typeof cell));
    }

    if (!data || data.length === 0 || !Array.isArray(data[0])) {
      Logger.log("âš ï¸ è³‡æ–™ç‚ºç©ºæˆ–æ ¼å¼éŒ¯èª¤");
      return { error: "è©¦ç®—è¡¨ç„¡æ•¸æ“šæˆ–æ ¼å¼éŒ¯èª¤", headers: [], rows: [] };
    }

    const headers = data[0].map(h => h?.toString().trim() || "");
    const rows = data.slice(1).filter(row => row.some(cell => cell != null && cell.toString().trim() !== ""));
    Logger.log("ğŸ“¦ æ¨™é ­ï¼š" + JSON.stringify(headers));
    Logger.log("ğŸ“¦ éæ¿¾å¾Œè¡Œæ•¸ï¼š" + rows.length);
    Logger.log("ğŸ“¦ éæ¿¾å¾Œè¡Œï¼š" + JSON.stringify(rows));

    // æ ¼å¼åŒ–æ—¥æœŸç‚ºé¦™æ¸¯æ™‚é–“ (HKT, UTC+8) çš„ dd/MM/yyyy HH:mm:ss
    const formattedRows = rows.map(row => 
      row.map(cell => {
        if (cell instanceof Date) {
          return Utilities.formatDate(cell, "GMT+8", "dd/MM/yyyy HH:mm:ss");
        }
        return cell;
      })
    );

    return {
      headers: headers,
      rows: formattedRows
    };
  } catch (error) {
    Logger.log("âŒ getData() éŒ¯èª¤ï¼š" + error.message);
    return { error: error.message, headers: [], rows: [] };
  }
}

function doUpdate(e) {
  try {
    const row = parseInt(e.parameter.row, 10) + 2;
    const col = parseInt(e.parameter.col, 10) + 1;
    const val = e.parameter.val;

    if (isNaN(row) || isNaN(col)) {
      Logger.log("âŒ doUpdate() åƒæ•¸éŒ¯èª¤ï¼šrow æˆ– col ç„¡æ•ˆ");
      return ContentService.createTextOutput(JSON.stringify({ error: "ç„¡æ•ˆçš„ row æˆ– col åƒæ•¸" }));
    }

    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    if (!sheet) {
      Logger.log("âŒ æ‰¾ä¸åˆ°å·¥ä½œè¡¨ï¼š" + SHEET_NAME);
      return ContentService.createTextOutput(JSON.stringify({ error: "æ‰¾ä¸åˆ°å·¥ä½œè¡¨" }));
    }

    sheet.getRange(row, col).setValue(val);
    sheet.getRange(row, 9).setValue(new Date());
    Logger.log(`ğŸ“ æ›´æ–°ï¼šè¡Œ ${row}, åˆ— ${col}, å€¼ ${val}`);

    return ContentService.createTextOutput("OK");
  } catch (error) {
    Logger.log("âŒ doUpdate() éŒ¯èª¤ï¼š" + error.message);
    return ContentService.createTextOutput(JSON.stringify({ error: error.message }));
  }
}

function doToggle(e) {
  try {
    const row = parseInt(e.parameter.row, 10) + 2;
    if (isNaN(row)) {
      Logger.log("âŒ doToggle() åƒæ•¸éŒ¯èª¤ï¼šrow ç„¡æ•ˆ");
      return ContentService.createTextOutput(JSON.stringify({ error: "ç„¡æ•ˆçš„ row åƒæ•¸" }));
    }

    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    if (!sheet) {
      Logger.log("âŒ æ‰¾ä¸åˆ°å·¥ä½œè¡¨ï¼š" + SHEET_NAME);
      return ContentService.createTextOutput(JSON.stringify({ error: "æ‰¾ä¸åˆ°å·¥ä½œè¡¨" }));
    }

    const statusCell = sheet.getRange(row, 8);
    const current = (statusCell.getValue() || "").toString().toLowerCase();
    const next = current === "completed" ? "Pending" : "Completed";
    statusCell.setValue(next);
    sheet.getRange(row, 9).setValue(new Date());
    Logger.log(`ğŸ“ åˆ‡æ›ç‹€æ…‹ï¼šè¡Œ ${row}, æ–°ç‹€æ…‹ ${next}`);

    return ContentService.createTextOutput("OK");
  } catch (error) {
    Logger.log("âŒ doToggle() éŒ¯èª¤ï¼š" + error.message);
    return ContentService.createTextOutput(JSON.stringify({ error: error.message }));
  }
}
