const SHEET_ID = "1h77IebbsEQmesShYKd49OTrqV6oTcXe60t-bEy5likM";
const SHEET_NAME = "OT Homework";

function doGet(e) {
  const action = e?.parameter?.action;
  if (action === "update") return doUpdate(e);
  if (action === "toggle") return doToggle(e);
  return ContentService.createTextOutput(JSON.stringify(getData()))
    .setMimeType(ContentService.MimeType.JSON);
}

function getData() {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    if (!sheet) {
      Logger.log("❌ 找不到工作表：" + SHEET_NAME);
      return { error: "找不到工作表：" + SHEET_NAME, headers: [], rows: [] };
    }

    const data = sheet.getDataRange().getValues();
    Logger.log("📦 數據範圍：" + sheet.getDataRange().getA1Notation());
    Logger.log("📦 資料筆數：" + data.length + " 行");
    if (data.length > 1) {
      Logger.log("📦 第二行：" + JSON.stringify(data[1]));
      Logger.log("📦 第二行類型：" + data[1].map(cell => typeof cell));
    }

    if (!data || data.length === 0 || !Array.isArray(data[0])) {
      Logger.log("⚠️ 資料為空或格式錯誤");
      return { error: "試算表無數據或格式錯誤", headers: [], rows: [] };
    }

    const headers = data[0].map(h => h?.toString().trim() || "");
    const rows = data.slice(1).filter(row => row.some(cell => cell != null && cell.toString().trim() !== ""));
    Logger.log("📦 標頭：" + JSON.stringify(headers));
    Logger.log("📦 過濾後行數：" + rows.length);
    Logger.log("📦 過濾後行：" + JSON.stringify(rows));

    // 格式化日期為香港時間 (HKT, UTC+8) 的 dd/MM/yyyy HH:mm:ss
    const formattedRows = rows.map(row => 
      row.map(cell => {
        if (cell instanceof Date) {
          return Utilities.formatDate(cell, "GMT+8", "dd/MM/yyyy HH:mm:ss");
        }
        return cell;
      })
    );

    return {
      headers: headers,
      rows: formattedRows
    };
  } catch (error) {
    Logger.log("❌ getData() 錯誤：" + error.message);
    return { error: error.message, headers: [], rows: [] };
  }
}

function doUpdate(e) {
  try {
    const row = parseInt(e.parameter.row, 10) + 2;
    const col = parseInt(e.parameter.col, 10) + 1;
    const val = e.parameter.val;

    if (isNaN(row) || isNaN(col)) {
      Logger.log("❌ doUpdate() 參數錯誤：row 或 col 無效");
      return ContentService.createTextOutput(JSON.stringify({ error: "無效的 row 或 col 參數" }));
    }

    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    if (!sheet) {
      Logger.log("❌ 找不到工作表：" + SHEET_NAME);
      return ContentService.createTextOutput(JSON.stringify({ error: "找不到工作表" }));
    }

    sheet.getRange(row, col).setValue(val);
    sheet.getRange(row, 9).setValue(new Date());
    Logger.log(`📝 更新：行 ${row}, 列 ${col}, 值 ${val}`);

    return ContentService.createTextOutput("OK");
  } catch (error) {
    Logger.log("❌ doUpdate() 錯誤：" + error.message);
    return ContentService.createTextOutput(JSON.stringify({ error: error.message }));
  }
}

function doToggle(e) {
  try {
    const row = parseInt(e.parameter.row, 10) + 2;
    if (isNaN(row)) {
      Logger.log("❌ doToggle() 參數錯誤：row 無效");
      return ContentService.createTextOutput(JSON.stringify({ error: "無效的 row 參數" }));
    }

    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    if (!sheet) {
      Logger.log("❌ 找不到工作表：" + SHEET_NAME);
      return ContentService.createTextOutput(JSON.stringify({ error: "找不到工作表" }));
    }

    const statusCell = sheet.getRange(row, 8);
    const current = (statusCell.getValue() || "").toString().toLowerCase();
    const next = current === "completed" ? "Pending" : "Completed";
    statusCell.setValue(next);
    sheet.getRange(row, 9).setValue(new Date());
    Logger.log(`📝 切換狀態：行 ${row}, 新狀態 ${next}`);

    return ContentService.createTextOutput("OK");
  } catch (error) {
    Logger.log("❌ doToggle() 錯誤：" + error.message);
    return ContentService.createTextOutput(JSON.stringify({ error: error.message }));
  }
}
